---
title: "Simulating and running HGAMs on spatio-temporal data"
author: "Adam Howes"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
suppressPackageStartupMessages({
  library(RtGam)
  library(ggplot2)
  library(gamtools)
  library(sf)
  library(dplyr)
  library(patchwork)
})
```

Plan:

1. Understand `simulate_sir` function
1. Create fake counties spatial structure
1. Simulate correlation structures for the fake counties
1. Create time series of $R_t$ with some spatio-temporal structure
1. Apply `simulate_sir` to each county
1. Extract data and format for input to `gamtools::prep_model_df`
1. Run model with `gamtools::run_model()`
1. Visualise results
1. Perform integration testing checks ready for e.g. `testthat` setting

## 1.

```{r}
sir <- simulate_sir(
  Rt = 0.5 * sin(seq_len(100)/10 * pi) + 1,
  S0 = 99000,
  I0 = 1000,
  R0 = 0,
  gamma = 0.5,
  delay_pmf = c(0.1, 0.2, 0.3, 0.4),
  k = 10,
  seed = 12345,
  date0 = as.Date("2023-01-01"),
  day_of_week = FALSE
)

ggplot(sir, aes(x = reference_date, y = value, col = parameter)) +
  geom_line() +
  theme_minimal() +
  facet_wrap(~parameter, scales = "free")
```

## 2.

```{r}
create_sf_grid <- function(height, width){
  sfc <- sf::st_sfc(sf::st_polygon(list(rbind(c(0, 0), c(width, 0), c(width, height), c(0, 0)))))
  grid <- sf::st_make_grid(sfc, cellsize = 1, square = TRUE)
  return(grid)
}

geometry <- create_sf_grid(height = 4, width = 4)

state_fips_code <- "99"
county_fips_code <- paste0("00", 1:length(geometry))
fips <- paste0(state_fips_code, county_fips_code)

sf <- sf::st_sf(geometry) |>
  mutate(fips = fips)

ggplot(sf) +
  geom_sf() +
  geom_sf_text(aes(label = fips)) +
  theme_void() +
  labs(title = "Mocked counties")
```

## 3.

```{r}
plot_matrix <- function(M, limits = NULL) {
  ggplot(
    reshape2::melt(M),
    aes(x = .data$Var1, y = .data$Var2, fill = .data$value)
  ) +
    labs(x = "", y = "", fill = "Value") +
    geom_tile() +
    scale_fill_viridis_c(limits = limits) +
    theme_void()
}

space_cov <- function(d, range, sill) {
  sill * exp(-d / range)
}

time_cov <- function(lag, rho) {
  rho^lag
}

reference_date <- seq.Date(
  from = as.Date("2025-01-01"),
  by = "week",
  length.out = 20
)

time_dist <- dist(reference_date) |> as.matrix()
time_cov <- time_cov(time_dist, rho = 0.9)

space_dist <- sf::st_distance(sf::st_centroid(sf)) |>
  as.matrix()

space_cov <- space_cov(
  space_dist,
  range = as.numeric(mean(space_dist)), sill = 1
)

space_time_cov <- kronecker(space_cov, time_cov)

time_corr <- plot_matrix(time_cov, limits = c(0, 1)) + labs(title = "Temporal", fill = "Correlation")
space_corr <- plot_matrix(space_cov, limits = c(0, 1)) + labs(title = "Spatial", fill = "Correlation")
space_time_corr <- plot_matrix(space_time_cov, limits = c(0, 1)) + labs(title = "Spatio-temporal", fill = "Correlation")

time_corr + space_corr

space_time_corr
```

## 4.

We will use a model like
$$
R_t = \mu_t + u_s + v_{st},
$$
where:

* $\mu_t$ is a smooth temporal trend
* $u_s$ is a spatially varying intercept
* $w_{st}$ is a spatio-temporal interaction

```{r}
n <- length(reference_date)

mu <- 0.5 * sin(seq_len(n) / 5 * pi)

mu_df <- data.frame(
  reference_date = reference_date,
  mu = mu
)

u_sd <- 0.1
u <- MASS::mvrnorm(
  n = 1,
  mu = rep(0, nrow(space_cov)),
  Sigma = u_sd * space_cov
)

u_df <- data.frame(
  fips = factor(fips, levels = fips),
  u = u
)

v_sd <- 0.05
v <- MASS::mvrnorm(
  n = 1,
  mu = rep(0, nrow(space_time_cov)),
  Sigma = v_sd * space_time_cov
)

rt_df <- tidyr::expand_grid(
  reference_date = reference_date,
  fips = factor(fips, levels = fips)
) |>
  left_join(
    mu_df,
    by = "reference_date"
  ) |>
  left_join(
    u_df,
    by = "fips"
  ) |>
  dplyr::mutate(
    v = v,
    rt = exp(mu + u + v)
  )

ggplot(rt_df, aes(x = reference_date, y = rt, col = fips)) +
  geom_line() +
  theme_minimal() +
  facet_wrap(. ~ fips, scales = "free_y")

mu_plot <- ggplot(mu_df, aes(x = reference_date, y = mu)) +
  geom_line() +
  labs(title = "Temporal effect")

u_plot <- ggplot(u_df, aes(x = fips, y = u)) +
  geom_point() +
  labs(title = "Spatial effect")

v_plot <- ggplot(rt_df, aes(x = reference_date, y = v, col = fips)) +
  geom_line() +
  labs(title = "Spatio-temporal effect")

mu_plot / u_plot / v_plot
```

## 5.

```{r}
rt_example <- rt_df |>
  filter(fips == "99001") |>
  arrange(reference_date) |>
  pull(rt)

simulate_sir(
  Rt = rt_example,
  S0 = 99000,
  I0 = 1000,
  R0 = 0,
  gamma = 0.5,
  delay_pmf = c(0.1, 0.2, 0.3, 0.4),
  k = 10,
  seed = 12345,
  date0 = as.Date("2023-01-01"),
  day_of_week = FALSE
)
```

## 6.