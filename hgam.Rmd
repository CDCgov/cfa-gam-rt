---
title: "Simulating and running HGAMs on spatio-temporal data"
author: "Adam Howes"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
suppressPackageStartupMessages({
  library(RtGam)
  library(ggplot2)
  library(gamtools)
  library(sf)
  library(dplyr)
})
```

Plan:

1. Understand `simulate_sir` function
1. Create fake counties spatial structure
1. Simulate $R_t$ in the fake counties using some kind of correlation structure
1. Apply `simulate_sir` to each county
1. Extract data and format for input to `gamtools::prep_model_df`
1. Run model with `gamtools::run_model()`
1. Visualise results
1. Perform integration testing checks ready for e.g. `testthat` setting

## 1.

```{r}
sir <- simulate_sir(
  Rt = 0.5 * sin(seq_len(100)/10 * pi) + 1,
  S0 = 99000,
  I0 = 1000,
  R0 = 0,
  gamma = 0.5,
  delay_pmf = c(0.1, 0.2, 0.3, 0.4),
  k = 10,
  seed = 12345,
  date0 = as.Date("2023-01-01"),
  day_of_week = FALSE
)

ggplot(sir, aes(x = reference_date, y = value, col = parameter)) +
  geom_line() +
  theme_minimal() +
  facet_wrap(~parameter, scales = "free")
```

## 2.

```{r}
create_sf_grid <- function(height, width){
  sfc <- sf::st_sfc(sf::st_polygon(list(rbind(c(0, 0), c(width, 0), c(width, height), c(0, 0)))))
  grid <- sf::st_make_grid(sfc, cellsize = 1, square = TRUE)
  return(grid)
}

geometry <- create_sf_grid(height = 4, width = 4)

state_fips_code <- "01"
county_fips_code <- paste0("00", 1:length(geometry))

sf <- sf::st_sf(geometry) |>
  mutate(fips = paste0(state_fips_code, county_fips_code))

ggplot(sf) +
  geom_sf() +
  geom_sf_text(aes(label = fips)) +
  theme_void() +
  labs(title = "Mocked counties")
```

## 3.

```{r}
space_cov <- function(d, range, sill) {
  sill * exp(-d / range)
}

time_cov <- function(lag, rho) {
  rho^lag
}
```

## 4.

## 5.

## 6.